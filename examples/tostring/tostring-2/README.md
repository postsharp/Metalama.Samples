---
uid: sample-tostring-2
summary: "This document describes enhancing a `ToString` aspect by adding a `[NotToString]` attribute and lightbulb menu suggestions for better customization and usability."
keywords: "ToString method, lightbulb menu, customization,  code fixes, refactorings"
created-date: 2024-09-05
modified-date: 2024-09-09
---

# ToString example, step 2: Adding code fixes and refactorings

[!metalama-project-buttons .]

In the previous step, we've seen how to create a trivial aspect that generates the `ToString` method on-the-fly during compilation. In this example, we'll add more features to the aspect:

* a `[NotToString]` attribute to opt-out a property from the `ToString` method,
* three additions to the lightbulb menu (also named refactoring menu):
 - on each property, a suggestion to add `[NotToString]`
 - on a type that has `[ToString]`, a suggestion to switch from aspect implementation to manual implementation
 - on a type that does _not_ have `[ToString]`, a suggestion to apply the aspect as a live template.

## Suggesting to apply the aspect as a live template



## Implementing the `[NotToString]` opt-opt attribute

When you're building an aspect, it's a good practice to provide users with simple ways to customize its behavior. In the case of `[ToString]` aspect, a typical requirement is to be able to remove a property from the generated interpolated string.

First, let's define a plain old custom attribute.

[!metalama-file NotToStringAttribute.cs]

To exclude fields and properties that have this attribute, we just have to add a filter to our query. Since we're going to reuse this query later, we extract it into a compile-time method of our aspect:

[!metalama-file ToStringAttribute.cs member="ToStringAttribute.GetIncludedProperties"]

We then update the `IntroducedToString` template method to use the `GetIncludedProperties` method.

## Suggesting to add `[NotToString]`

How do we make sure that our users _know_ that they can use our `[NotToString]` attribute?

Code fixes and code refactorings, which appear in the lightbulb or screwdriver menu, are an excellent way to improve the discoverability of our aspect-oriented API, and therefore the overall _developer experience_ of our product.

We'll now see how we can add an item to the lightbulb menu of each property included in the `ToString` generated by our aspect.

To add code fixes and refactorings, we must implement the <xref:Metalama.Framework.Aspects.IAspect`1.BuildAspect*> method. We then identify all relevant properties (those returned by the `GetIncludedProperties` method), and call the <xref:Metalama.Framework.Diagnostics.ScopedDiagnosticSink.Suggest*> method. This method excepts an argument of type <xref:Metalama.Framework.CodeFixes.CodeFix>.

To create the code fix, we use the <xref:Metalama.Framework.CodeFixes.CodeFixFactory.AddAttribute*?text=CodeFixFactory.AddAttribute> method, which simply adds a custom attribute to the specified declaration. 

[!metalama-file ToStringAttribute.cs marker="AddNotToStringCodeFix"]

To learn more about code fixes and refactorings, see <xref:code-fixes>.

## Suggesting to switch to a manual implementation

There is no silver bullet, and our `[ToString]` aspect does not pretend to cover all situations. 

Of course, when users hit some limitation of our aspect, they could remove the aspect and re-implement the `ToString` by hand. However, wouldn't it be easier to directly _edit_ the source code generated by the aspect? That's what we are going to show here.

Our objective is to create a code refactoring that will apply the aspect directly to the source code, in the editor, and remove both the `[ToString]` and `[NotToString]` attributes.

As in the previous code fix, this can be achieved by calling the <xref:Metalama.Framework.Diagnostics.ScopedDiagnosticSink.Suggest*> method -- this time, adding a suggestion to the type itself. The main difference is that, instead of using one of the ready-made code fixes offered by the <xref:Metalama.Framework.CodeFixes.CodeFixFactory> class, we will have to create our own. To do this, we need to create a <xref:Metalama.Framework.CodeFixes.CodeFix> instance and to supply a delegate that will apply the code fix in three steps:

1. Apply the aspect.
2. Remove any `[ToString]` attribute.
3. Remove any `[NotToString]` attribute.

Here is the code:

[!metalama-file ToStringAttribute.cs marker="SwitchToManualImplementation"]





